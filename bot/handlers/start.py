"""Start command handler."""

from telegram import Update
from telegram.ext import CommandHandler, ContextTypes

from config.logging_config import get_logger
from config.settings import settings
from database.session import get_db
from database.repositories.user_repository import UserRepository

logger = get_logger(__name__)


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle /start command."""
    user = update.effective_user
    if not user:
        return

    try:
        db = next(get_db())
        user_repo = UserRepository(db)
    except Exception as e:
        logger.error(f"Database error: {e}", exc_info=True)
        # Try to initialize database if tables don't exist
        from database.base import init_db
        init_db()
        db = next(get_db())
        user_repo = UserRepository(db)

    # Check if user exists
    existing_user = user_repo.get_by_telegram_id(user.id)
    if existing_user:
        # Update activity
        user_repo.update_activity(existing_user.id)
        welcome_message = (
            f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n\n"
            "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."
        )
    else:
        # Create new user
        is_admin = user.id in settings.admin_ids_list
        new_user = user_repo.create(
            telegram_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name,
            is_admin=is_admin,
        )
        logger.info(f"New user registered: {new_user.telegram_id} ({new_user.username})")
        welcome_message = (
            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}! üëã\n\n"
            "–Ø –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–∞–∫–∞–Ω—Å–∏–π —Å —Å–∞–π—Ç–∞ gsz.gov.by –∏ –¥—Ä—É–≥–∏—Ö —Å–∞–π—Ç–æ–≤ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.\n\n"
            "üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n\n"
            "/help - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º\n"
            "/search - –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–ø—Ä–æ—Ñ–µ—Å—Å–∏—è, –≥–æ—Ä–æ–¥, –∫–æ–º–ø–∞–Ω–∏—è)\n"
            "/filters - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ–∏—Å–∫–∞\n"
            "/monitor_start - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π\n"
            "/monitor_list - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n"
            "/export - —ç–∫—Å–ø–æ—Ä—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π –≤ Excel —Ñ–∞–π–ª\n"
            "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞\n\n"
            "–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /help –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!"
        )

    await update.message.reply_text(welcome_message)


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle /help command."""
    help_text = (
        "üìã <b>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>\n\n"
        
        "üîç <b>–ü–û–ò–°–ö –í–ê–ö–ê–ù–°–ò–ô:</b>\n"
        "/search - –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º\n"
        "   –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é, –≥–æ—Ä–æ–¥/–æ–±–ª–∞—Å—Ç—å, –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏\n"
        "   –ë–æ—Ç –Ω–∞–π–¥—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n"
        
        "üìù <b>–§–ò–õ–¨–¢–†–´ –ü–û–ò–°–ö–ê:</b>\n"
        "–§–∏–ª—å—Ç—Ä—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n\n"
        "/filters - —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏)\n"
        "/add_filter - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä\n"
        "   ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, –≥–æ—Ä–æ–¥, –∫–æ–º–ø–∞–Ω–∏—è\n"
        "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/search) –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (/monitor_start)\n\n"
        
        "üîî <b>–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ù–ò–¢–û–†–ò–ù–ì:</b>\n"
        "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∞–π—Ç—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π\n"
        "–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π\n\n"
        "/monitor_start - –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞\n"
        "   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä\n"
        "   ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (1 —á–∞—Å, 3 —á–∞—Å–∞ –∏ —Ç.–¥.)\n"
        "   ‚Ä¢ –ë–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–∞–π—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –æ –Ω–æ–≤—ã—Ö –≤–∞–∫–∞–Ω—Å–∏—è—Ö\n"
        "/monitor_list - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n"
        "/monitor_stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n"
        "/monitor_set_interval - –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∑–∞–¥–∞—á–∏\n\n"
        
        "üìä <b>–≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–•:</b>\n"
        "/export - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ Excel —Ñ–∞–π–ª\n"
        "   ‚Ä¢ –ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–ª–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É\n"
        "   ‚Ä¢ –§–∞–π–ª –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å: –¥–∞—Ç—É, –∫–æ–º–ø–∞–Ω–∏—é, –∞–¥—Ä–µ—Å, –ø—Ä–æ—Ñ–µ—Å—Å–∏—é,\n"
        "     –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç, –∑–∞—Ä–ø–ª–∞—Ç—É, –∫–æ–Ω—Ç–∞–∫—Ç—ã\n\n"
        
        "üìà <b>–°–¢–ê–¢–ò–°–¢–ò–ö–ê:</b>\n"
        "/stats - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:\n"
        "   ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π\n"
        "   ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n"
        "   ‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∑–∞–¥–∞—á–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n\n"
        
        "‚ÑπÔ∏è <b>–î–†–£–ì–ò–ï –ö–û–ú–ê–ù–î–´:</b>\n"
        "/start - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        
        "üí° <b>–°–æ–≤–µ—Ç:</b> –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ (/add_filter), "
        "–∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ (/search) –∏–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (/monitor_start)"
    )

    await update.message.reply_text(help_text, parse_mode="HTML")


# Handlers
start_handler = CommandHandler("start", start_command)
help_handler = CommandHandler("help", help_command)
